#!/bin/bash
# ============================================
# Xray Manager with Trial, Log & Telegram Notify
# ============================================

config="/etc/xray/config.json"
domain=$(cat /etc/xray/domain)
port_tls=443
port_ntls=80
log_file="/var/log/xray-trial.log"

# ðŸ”¹ Konfigurasi Telegram
BOT_TOKEN=$(cat /etc/per/tokenl)
CHAT_ID=$(cat /etc/per/id)

send_telegram() {
    local message="$1"
    curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
        -d chat_id=$CHAT_ID \
        -d text="$message" >/dev/null
}

log_delete() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') | User $1 expired & deleted" >> $log_file
    send_telegram "ðŸ”¥ XRAY INFO ðŸ”¥%0AUser: $1%0AStatus: Expired & Deleted%0ATime: $(date '+%Y-%m-%d %H:%M:%S')"
}

make_vmess() {
    read -p "Durasi trial (menit): " menit
    user=trial-vmess-$(date +%s)
    uuid=$(uuidgen)

    sed -i '/#vmess$/a\#vm '"$user $menit menit"' \n},{"id": "'$uuid'","alterId": 0,"email": "'$user'"}' $config
    sed -i '/#vmess$/a\#vmg '"$user $menit menit"' \n},{"id": "'$uuid'","alterId": 0,"email": "'$user'"}' $config
    systemctl restart xray

    vmess_link="vmess://$(echo -n '{
      "v": "2",
      "ps": "'$user'",
      "add": "'$domain'",
      "port": "'$port_tls'",
      "id": "'$uuid'",
      "aid": "0",
      "net": "ws",
      "type": "none",
      "host": "'$domain'",
      "path": "/vmess",
      "tls": "tls"
    }' | base64 -w 0)"

    echo -e "\n=== Trial VMess Created ==="
    echo "User    : $user"
    echo "UUID    : $uuid"
    echo "Expired : $menit menit"
    echo -e "Link VMess:\n$vmess_link"

    send_telegram "âœ… Trial Account Created%0AType: VMess%0AUser: $user%0ADuration: $menit menit%0ADomain: $domain"

    echo "sed -i '/$user/d' $config && systemctl restart xray && $(declare -f log_delete); log_delete $user" | at now + $menit minutes
}

make_vless() {
    read -p "Durasi trial (menit): " menit
    user=trial-vless-$(date +%s)
    uuid=$(uuidgen)

    sed -i '/#vless$/a\#vl '"$user $menit menit"' \n},{"id": "'$uuid'","email": "'$user'"}' $config
    sed -i '/#vless$/a\#vlg '"$user $menit menit"' \n},{"id": "'$uuid'","email": "'$user'"}' $config
    systemctl restart xray

    vless_link="vless://${uuid}@${domain}:${port_tls}?type=ws&encryption=none&host=${domain}&path=/vless&security=tls#${user}"

    echo -e "\n=== Trial VLess Created ==="
    echo "User    : $user"
    echo "UUID    : $uuid"
    echo "Expired : $menit menit"
    echo -e "Link VLess:\n$vless_link"

    send_telegram "âœ… Trial Account Created%0AType: VLess%0AUser: $user%0ADuration: $menit menit%0ADomain: $domain"

    echo "sed -i '/$user/d' $config && systemctl restart xray && $(declare -f log_delete); log_delete $user" | at now + $menit minutes
}

make_trojan() {
    read -p "Durasi trial (menit): " menit
    user=trial-trojan-$(date +%s)
    uuid=$(uuidgen)

    sed -i '/#trojan$/a\#tr '"$user $menit menit"' \n},{"password": "'$uuid'","email": "'$user'"}' $config
    sed -i '/#trojan$/a\#trg '"$user $menit menit"' \n},{"password": "'$uuid'","email": "'$user'"}' $config
    systemctl restart xray

    trojan_link="trojan://${uuid}@${domain}:${port_tls}?security=tls&type=ws&path=/trojan#${user}"

    echo -e "\n=== Trial Trojan Created ==="
    echo "User    : $user"
    echo "Password: $uuid"
    echo "Expired : $menit menit"
    echo -e "Link Trojan:\n$trojan_link"

    send_telegram "âœ… Trial Account Created%0AType: Trojan%0AUser: $user%0ADuration: $menit menit%0ADomain: $domain"

    echo "sed -i '/$user/d' $config && systemctl restart xray && $(declare -f log_delete); log_delete $user" | at now + $menit minutes
}

cek_user() {
    echo -e "\n=== Daftar User Aktif ==="
    grep -E "^#trial-|^#user" $config | cut -d ' ' -f1,2
    echo -e "=========================="
}

hapus_user() {
    read -p "Masukkan username yang mau dihapus: " user
    if grep -q "$user" $config; then
        sed -i "/$user/d" $config
        systemctl restart xray
        log_delete $user
        echo "User $user berhasil dihapus!"
    else
        echo "User $user tidak ditemukan."
    fi
}

lihat_log() {
    echo -e "\n=== Log Auto Delete User ==="
    if [[ -f $log_file ]]; then
        cat $log_file
    else
        echo "Belum ada log."
    fi
    echo -e "============================"
}

while true; do
    clear
    echo "==============================="
    echo "       MENU XRAY MANAGER"
    echo "==============================="
    echo "1) Buat Trial VMess"
    echo "2) Buat Trial VLess"
    echo "3) Buat Trial Trojan"
    echo "-------------------------------"
    echo "4) Cek User Aktif"
    echo "5) Hapus User Manual"
    echo "6) Lihat Log Auto Delete"
    echo "0) Keluar"
    echo "==============================="
    read -p "Pilih menu: " opt
    case $opt in
        1) make_vmess ;;
        2) make_vless ;;
        3) make_trojan ;;
        4) cek_user ;;
        5) hapus_user ;;
        6) lihat_log ;;
        0) exit ;;
        *) echo "Pilihan tidak valid!" ;;
    esac
    read -n 1 -s -r -p "Tekan Enter untuk lanjut..."
done
